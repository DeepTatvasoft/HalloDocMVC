@{
    Layout = "";
}
@model Services.ViewModels.NewStateData

<div id="status-tabContent" style="box-shadow: 1px 1px 5px; padding-bottom:15px">
    <div class="table-responsive text-white mt-3" style="height:100%;">
        <table class="table d-none d-md-table" id="maintable">
            <thead>
                <tr>
                    <th scope="col">Name</th>
                    <th scope="col"> </th>
                    <th scope="col">Phone</th>
                    <th scope="col">Address</th>
                    <th scope="col">Status</th>
                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody style="--bs-table-color: white;" id="myTable">
                @if (Model.req!.Count() == 0)
                {
                    <tr>
                        <td colspan="6" class="text-center text-secondary">No Data Found</td>
                    </tr>
                }
                @foreach (var obj in Model.req)
                {
                    var reqclient = obj.Requestclients.ElementAt(0);
                    var color = "mediumpurple";
                    var type = "";
                    @if (obj.Requesttypeid == 1)
                    {
                        color = "rgb(72 169 70)";
                        type = "Patient";
                    }
                    else if (obj.Requesttypeid == 2)
                    {
                        color = "#f5a33e";
                        type = "Family";
                    }
                    else if (obj.Requesttypeid == 4)
                    {
                        color = "hotpink";
                        type = "Business";
                    }
                    else if (obj.Requesttypeid == 3)
                    {
                        color = "dodgerblue";
                        type = "Concierge";
                    }
                    <tr style="--bs-table-bg:@color " class="@type">
                        <td scope="row">@reqclient.Firstname, @reqclient.Lastname</td>
                        <td scope="row">
                            <a href="mailto:@reqclient.Email" type="button" class="btn btn-outline-light"><i class="fa-regular fa-envelope"></i></a>
                        </td>
                        <td scope="row">
                            <div class="phone p-1">
                                <a class="text-decoration-none text-white" href="tel:@obj.Phonenumber">@obj.Phonenumber</a>
                            </div>
                            (Patient)
                            @if (type != "Patient")
                            {
                                <div class="phone p-1">
                                    <a href="tel:@reqclient.Phonenumber" class="text-decoration-none text-white">@reqclient.Phonenumber</a>
                                </div>
                                <span>(@type)</span>
                            }
                        </td>
                        <td scope="row">@reqclient.Address</td>
                        <td scope="row">
                            @if (obj.Status == 5)
                            {
                                <a asp-action="HouseCallBtn" asp-controller="Physician" asp-route-id="@obj.Requestid" class="btn btn-info text-white">House Call</a>
                            }
                        </td>
                        <td scope="row">
                            <div class="dropdown ms-2">
                                <button class="btn btn-outline-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Actions
                                </button>
                                <ul class="dropdown-menu">
                                    <li style="cursor : pointer"><a class="dropdown-item viewcase" id="@obj.Requestid"><i class="bi bi-view-list me-2"></i>View case</a></li>
                                    <li style="cursor : pointer"><a class="dropdown-item viewuploads" name="@obj.Requestid"><i class="fa-regular fa-file me-2"></i>View Uploads</a></li>
                                    <li>
                                        <a class="dropdown-item viewnotes" name="@obj.Requestid">
                                            <i class="fa-solid fa-book-journal-whills me-2"></i>View Notes
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item sendorder" name="@obj.Requestid" href="#">
                                            <i class="fa-solid fa-cart-shopping me-2"></i>Orders
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#encounterModal" onclick="EncounterModalOpen(@obj.Requestid)">
                                            <i class="fa-solid fa-file me-2"></i>Encounter
                                        </a>
                                    </li>
                                </ul>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>


        <div class="accordion accordion-flush d-md-none d-block" id="accordionFlushExample">

            <div class="accordion-item">
                @foreach (var item in Model.req!)
                {
                    var reqclient = item.Requestclients.ElementAt(0);
                    var color = "mediumpurple";
                    var type = "";
                    @if (item.Requesttypeid == 1)
                    {
                        color = "rgb(117,201,115)";
                        type = "Patient";
                    }
                    else if (item.Requesttypeid == 2)
                    {
                        color = "rgb(219,161,36)";
                        type = "Family";
                    }
                    else if (item.Requesttypeid == 3)
                    {
                        color = "rgb(230, 0 , 115)";
                        type = "Concierge";
                    }
                    else if (item.Requesttypeid == 4)
                    {
                        color = "rgb(0,172,230)";
                        type = "Business";
                    }
                    <h2 class="accordion-header" id="flush-headingOne">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#flush-collapseone-@item.Requestid" aria-expanded="false" aria-controls="flush-collapseOne" style="background-color:#e7f1ff; color:black">

                            <div class="col d-flex flex-column">
                                <span class="">@reqclient.Firstname, @reqclient.Lastname</span>
                                <span class=" mt-4">@reqclient.Street @reqclient.City @reqclient.State</span>
                            </div>

                            <div class="col d-flex flex-column text-end mt-2 p-0">
                                <div>
                                    <div>
                                        <span>@type</span>
                                        <i class="bi bi-circle-fill" style="color :@color "></i>
                                    </div>
                                    <div class=" btn rounded-pill text-info border-info float-end p-1 my-3" style="width:150px">
                                        Map Location
                                    </div>

                                </div>

                            </div>
                        </button>
                        <hr class="m-0">
                    </h2>

                    <div id="flush-collapseone-@item.Requestid" class="accordion-collapse collapse p-2" aria-labelledby="flush-headingOne" data-bs-parent="#accordionFlushExample" style="background-color:#e7f1ff; color:black; border-bottom : 2px solid black;">
                        <div class="d-flex justify-content-end">
                            <div class="rounded-pill me-3 viewCaseBtn p-2 bg-white viewcase" id="@item.Requestid" style="cursor : pointer">
                                View Case
                            </div>
                        </div>

                        <div class="accordion-body d-flex flex-column gap-1 p-0">
                            <div><i class="bi bi-envelope me-2 icn"></i>Email: @reqclient.Email</div>
                            <div><i class="bi bi-telephone me-2 icn"></i>Patient: @reqclient.Phonenumber</div>
                        </div>

                        <div class="row my-2 mx-0">
                            <div class="col-6 p-2">
                                <a class="btn w-100 bg-success text-white rounded-pill p-1 btn-sm viewnotes" name="@item.Requestid">View Notes</a>
                            </div>

                            <div class="col-6 p-2">
                                <a class="btn w-100  text-white rounded-pill p-1 btn-sm" style="background:#1d5100;">Doctors Note</a>
                            </div>

                            <div class="col-6 p-2">
                                <a class="btn w-100 bg-success text-white rounded-pill p-1 btn-sm viewuploads" name="@item.Requestid">View Uploads</a>
                            </div>

                            <div class="col-6 p-2">
                                <a class="btn w-100 bg-success text-white rounded-pill p-1 btn-sm" data-bs-toggle="modal" data-bs-target="#encounterModal" onclick="EncounterModalOpen(@item.Requestid)">Encounter</a>
                            </div>

                            <div class="col-6 p-2">
                                <a class="btn w-100  text-white rounded-pill p-1 btn-sm sendorder" name="@item.Requestid" style="background: #e3a800;">Orders</a>
                            </div>
                            @if (item.Status == 5)
                            {
                                <div class="col-6 p-2">
                                    <a asp-action="HouseCallBtn" asp-controller="Physician" asp-route-id="@item.Requestid" class="btn w-100  text-white rounded-pill p-1 btn-sm" style="background: #2cd3fb;">House Call</a>
                                </div>
                            }

                            <div class="col-6 p-2">
                                <a href="mailto:@reqclient.Email" class="btn w-100 bg-success text-white rounded-pill p-1 btn-sm">Email</a>
                            </div>

                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
    <div class="d-flex justify-content-center gap-3 mt-3">
        @if (Model.totalpages > 0)
        {
            var previous = Model.currentpage - 1;
            var next = Model.currentpage + 1;
            if (previous <= 0)
            {
                previous = 1;
            }
            if (next > Model.totalpages)
            {
                next = Model.totalpages;
            }
            <button class="@previous pagebtn" id="page-0" onclick="ChangePagePhy(@previous ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')" style="width:75px">
                Previous
            </button>
            @if (Model.totalpages > 5)
            {
                @if (Model.currentpage > Model.totalpages - 3)
                {
                    <button class="1 pagebtn" id="page-1" onclick="ChangePagePhy(1 ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                        1
                    </button>
                    <button class="0 pagebtn" id="page-0">
                        ...
                    </button>
                    @for (var i = Model.totalpages - 3; i <= Model.totalpages; i++)
                    {
                        <button class="@i pagebtn" id="page-@i" onclick="ChangePagePhy(@i ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                            @i
                        </button>
                    }
                }
                else if (Model.currentpage < Model.totalpages - 2 && Model.currentpage > 3)
                {
                    <button class="1 pagebtn" id="page-1" onclick="ChangePagePhy(1 ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                        1
                    </button>
                    <button class="0 pagebtn" id="page-0">
                        ...
                    </button>
                    @for (var i = Model.currentpage - 1; i <= Model.currentpage + 1; i++)
                    {
                        <button class="@i pagebtn" id="page-@i" onclick="ChangePagePhy(@i ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                            @i
                        </button>
                    }
                    <button class="0 pagebtn" id="page-0">
                        ...
                    </button>
                    <button class="@Model.totalpages pagebtn" id="page-@Model.totalpages" onclick="ChangePagePhy(@Model.totalpages ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                        @Model.totalpages
                    </button>
                }
                else
                {
                    @for (var i = 1; i <= 4; i++)
                    {
                        <button class="@i pagebtn" id="page-@i" onclick="ChangePagePhy(@i ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                            @i
                        </button>
                    }
                    <button class="0 pagebtn" id="page-0">
                        ...
                    </button>
                    <button class="@Model.totalpages pagebtn" id="page-@Model.totalpages" onclick="ChangePagePhy(@Model.totalpages ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                        @Model.totalpages
                    </button>
                }
            }
            else
            {
                @for (int page = 0; page < Model.totalpages; page++)
                {
                    var temp = page + 1;

                    <button class="@temp pagebtn" id="page-@temp" onclick="ChangePagePhy(@temp ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')">
                        @temp
                    </button>
                }
            }
            <button class="@next pagebtn" id="page-@next" onclick="ChangePagePhy(@next ,4, '@Model.reqtype' , @Model.region,'@Model.searchkey')" style="width:75px">
                Next
            </button>
        }
    </div>
</div>

@*Encounter Modal*@
<div class="modal fade" id="encounterModal" tabindex="-1" aria-labelledby="encounterModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h1 class="modal-title fs-5 text-white" id="encounterModalLabel">Select Type Of Care</h1>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Physician" asp-action="EncounterBtn">
                <input type="hidden" asp-for="reqid" id="reqidhidden" />
                <div class="modal-body">
                    <div class="d-flex justify-content-center">
                        <input value="housecall" type="radio" class="btn-check" name="encounterchk" id="success-outlined" autocomplete="off" checked>
                        <label class="btn btn-outline-info me-2" for="success-outlined">Housecall</label>

                        <input value="consult" type="radio" class="btn-check" name="encounterchk" id="danger-outlined" autocomplete="off">
                        <label class="btn btn-outline-info" for="danger-outlined">Consult</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-info text-white" data-bs-dismiss="modal">Save</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        var page = document.getElementById("page-@Model.currentpage");
        if (page != null) {
            page.style.backgroundColor = "lightblue";
        }
        $('.viewcase').on('click', function (e) {
            e.preventDefault();
            localStorage.setItem('state', 'active');
            //$('.dashboardtab').removeClass('active');
            //$(this).addClass('active');
            var id = $(this).attr('id');
            $.ajax({
                url: '/Admin/ViewCase',
                data: { "id": id },
                success: function (response) {
                    $('#alldata').html(response);
                    console.log("Fetch success");
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        });
        $('.viewnotes').on('click', function (e) {
            e.preventDefault();
            localStorage.setItem('state', 'active');
            //$('.dashboardtab').removeClass('active');
            //$(this).addClass('active');
            var reqid = $(this).attr('name');
            $.ajax({
                url: '/Admin/ViewNotes',
                data: { "reqid": reqid },
                success: function (response) {
                    $('#alldata').html(response);
                    console.log("Fetch success");
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        });
        $('.viewuploads').on('click', function (e) {
            e.preventDefault();
            localStorage.setItem('state', 'active');
            //$('.dashboardtab').removeClass('active');
            //$(this).addClass('active');
            var reqid = $(this).attr('name');
            //console.log(reqid);
            console.log($('#ViewcaseRemove').attr('id'));
            $('#ViewcaseRemove').removeClass("d-flex").addClass("d-none");
            //$('#myTab').remove();

            $.ajax({
                url: '/Admin/AdminuploadDoc',
                data: { "reqid": reqid },
                success: function (response) {
                    $('#alldata').html(response);
                    console.log("Fetch success");
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        });
        $('.sendorder').on('click', function (e) {
            e.preventDefault();
            localStorage.setItem('state', 'active');
            var reqid = $(this).attr('name');
            $.ajax({
                url: '/Admin/Orders',
                data: { "reqid": reqid },
                success: function (response) {
                    $('#alldata').html(response);
                    console.log("Fetch success");
                },
                error: function (xhr, status, error) {
                    console.error(error);
                }
            });
        });
    });
</script>
